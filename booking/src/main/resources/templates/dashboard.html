<!DOCTYPE html>
<html lang="uk" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>–ö–∞–±—ñ–Ω–µ—Ç –∫–ª—ñ—î–Ω—Ç–∞</title>
    <link rel="stylesheet" href="/css/beauty-salon.css">
    <style>
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 10px; border: 1px solid #ddd; text-align: left; }
        th { background-color: #f4f4f4; }

        .btn-action { padding: 5px 10px; margin-right: 5px; cursor: pointer; border: none; color: white; border-radius: 4px; text-decoration: none; font-size: 13px;}
        .btn-confirm { background-color: #28a745; }
        .btn-pay { background-color: #007bff; }
        .btn-complete { background-color: #17a2b8; }
        .btn-cancel { background-color: #dc3545; }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content { position: relative; }

        .close-btn {
            position: absolute;
            top: -40px; right: 0;
            color: white; font-size: 30px; cursor: pointer;
        }

        .card {
            background: linear-gradient(135deg, #007bff, #004080);
            border-radius: 15px;
            padding: 20px;
            width: 350px;
            height: auto;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .card-chip {
            width: 50px; height: 30px;
            background-color: gold;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .card-form { display: flex; flex-direction: column; gap: 15px; }
        .input-group { display: flex; flex-direction: column; gap: 5px; }
        .input-group label { font-weight: bold; font-size: 12px; }

        .input-group input, .input-group textarea {
            padding: 8px;
            border: none; border-radius: 5px; font-size: 14px;
            outline: none; background: rgba(255, 255, 255, 0.2); color: white;
        }

        #reviewModal textarea {
             background: white; color: black; border: 1px solid #ccc;
        }

        .input-group input::placeholder { color: rgba(255, 255, 255, 0.7); }

        .flex-row { display: flex; justify-content: space-between; gap: 10px; }
        .half { width: 48%; }

        .btn-submit-pay {
            padding: 10px; background-color: #28a745; color: white;
            border: none; border-radius: 5px; font-size: 16px;
            cursor: pointer; transition: background-color 0.3s ease; margin-top: 10px;
        }

        .btn-submit-pay:hover { background-color: #218838; }

        .payment-amount { text-align: center; font-size: 1.2em; margin-bottom: 10px; font-weight: bold; }

        .master-cell {
            position: relative;
            cursor: pointer;
        }

        .review-tooltip {
            visibility: hidden;
            width: 120px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 0;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -60px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
        }

        .master-cell.completed:hover .review-tooltip {
            visibility: visible;
            opacity: 1;
        }

        .master-cell.completed {
            color: #007bff;
            text-decoration: underline;
        }

        .rating {
            display: flex;
            flex-direction: row-reverse;
            justify-content: center;
            gap: 5px;
        }

        .rating input { display: none; }

        .rating label {
            font-size: 30px;
            color: #ccc;
            cursor: pointer;
        }

        .rating input:checked ~ label,
        .rating label:hover,
        .rating label:hover ~ label {
            color: gold;
        }
    </style>
</head>
<body>
    <div class="dashboard-card" style="width: 80%; max-width: 1000px;">
        <div class="content">
            <h1>–û—Å–æ–±–∏—Å—Ç–∏–π –∫–∞–±—ñ–Ω–µ—Ç</h1>

            <div th:if="${success}" style="background-color: #d4edda; color: #155724; padding: 10px; margin-bottom: 20px; border-radius: 5px; border: 1px solid #c3e6cb;">
                <span th:text="${success}"></span>
            </div>
            <div th:if="${error}" style="background-color: #f8d7da; color: #721c24; padding: 10px; margin-bottom: 20px; border-radius: 5px; border: 1px solid #f5c6cb;">
                <span th:text="${error}"></span>
            </div>

            <div class="user-greeting">
                –í—ñ—Ç–∞—î–º–æ, <span th:text="${user.name}">–ö–ª—ñ—î–Ω—Ç</span>!
            </div>

            <div style="margin: 20px 0;">
                <a href="/web/bookings/new" class="btn-primary" style="text-decoration: none;">+ –ù–æ–≤–∏–π –∑–∞–ø–∏—Å</a>
            </div>

            <h3>–ú–æ—ó –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è:</h3>

            <div th:if="${#lists.isEmpty(user.bookings)}">
                <p>–£ –≤–∞—Å –ø–æ–∫–∏ –Ω–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–∏—Ö –±—Ä–æ–Ω—é–≤–∞–Ω—å.</p>
            </div>

            <table th:if="${not #lists.isEmpty(user.bookings)}">
                <thead>
                    <tr>
                        <th>–ü–æ—Å–ª—É–≥–∞</th>
                        <th>–ú–∞–π—Å—Ç–µ—Ä</th>
                        <th>–î–∞—Ç–∞</th>
                        <th>–¶—ñ–Ω–∞</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–î—ñ—ó</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="booking : ${user.bookings}">
                        <td th:text="${booking.service.name}"></td>

                        <td class="master-cell"
                            th:classappend="${booking.status.name() == 'COMPLETED'} ? 'completed' : ''"
                            th:data-id="${booking.bookingId}"
                            onclick="if(this.classList.contains('completed')) openReviewModal(this.getAttribute('data-id'))">

                            <span th:text="${booking.master.user.name}"></span>

                            <span th:if="${booking.status.name() == 'COMPLETED'}" class="review-tooltip">
                                –ó–∞–ª–∏—à–∏—Ç–∏ –≤—ñ–¥–≥—É–∫
                            </span>
                        </td>

                        <td th:text="${booking.bookingDate} + ' ' + ${booking.bookingTime}"></td>
                        <td th:text="${booking.totalPrice} + ' –≥—Ä–Ω'"></td>

                        <td th:text="${booking.status}" style="font-weight: bold;"></td>

                        <td>
                            <div style="display: flex; gap: 5px;">
                                <form th:if="${booking.status.name() == 'PENDING'}"
                                      th:action="@{/web/bookings/{id}/confirm(id=${booking.bookingId})}" method="post">
                                    <button type="submit" class="btn-action btn-confirm">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏</button>
                                </form>

                                <button th:if="${booking.status.name() == 'CONFIRMED'}"
                                        type="button"
                                        class="btn-action btn-pay"
                                        th:onclick="openPaymentModal([[${booking.bookingId}]], [[${booking.totalPrice}]])">
                                    –û–ø–ª–∞—Ç–∏—Ç–∏
                                </button>

                                <form th:if="${booking.status.name() != 'CANCELLED' and booking.status.name() != 'COMPLETED'}"
                                      th:action="@{/web/bookings/{id}/cancel(id=${booking.bookingId})}" method="post">
                                    <button type="submit" class="btn-action btn-cancel">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                                </form>

                                <a th:if="${booking.status.name() == 'PAID' or booking.status.name() == 'COMPLETED' or (booking.status.name() == 'CANCELLED' and booking.payment != null)}"
                                   th:href="@{/web/bookings/{id}/receipt(id=${booking.bookingId})}"
                                   target="_blank"
                                   class="btn-action"
                                   style="background-color: #6c757d; text-decoration: none; display: flex; align-items: center; justify-content: center;"
                                   title="–ö–≤–∏—Ç–∞–Ω—Ü—ñ—è">
                                   üìÑ
                                </a>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>

            <div class="footer">
                <a href="/auth/logout">–í–∏–π—Ç–∏</a>
            </div>
        </div>
    </div>

    <div id="paymentModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-btn" onclick="closePaymentModal()">&times;</span>
            <div class="card">
                <div class="payment-amount" id="modalAmountDisplay">–î–æ —Å–ø–ª–∞—Ç–∏: 0 –≥—Ä–Ω</div>
                <div class="card-chip"></div>
                <form id="cardForm" class="card-form" method="post">
                    <input type="hidden" name="paymentMethod" value="CARD">
                    <div class="input-group">
                        <label for="card-number">–ù–æ–º–µ—Ä –∫–∞—Ä—Ç–∫–∏</label>
                        <input type="text" id="card-number" name="cardNumber" placeholder="XXXX XXXX XXXX XXXX" required maxlength="19">
                    </div>
                    <div class="flex-row">
                        <div class="input-group half">
                            <label for="expiry-date">–¢–µ—Ä–º—ñ–Ω –¥—ñ—ó</label>
                            <input type="text" id="expiry-date" placeholder="MM/RR" required maxlength="5">
                        </div>
                        <div class="input-group half">
                            <label for="cvv">CVV</label>
                            <input type="password" id="cvv" placeholder="XXX" required maxlength="3">
                        </div>
                    </div>
                    <button type="submit" class="btn-submit-pay">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –æ–ø–ª–∞—Ç—É</button>
                </form>
            </div>
        </div>
    </div>

    <div id="reviewModal" class="modal-overlay">
        <div class="modal-content" style="background: white; padding: 30px; border-radius: 10px; width: 400px; text-align: center;">
            <span class="close-btn" onclick="closeReviewModal()" style="color: #333; top: 10px; right: 15px;">&times;</span>
            <h2 style="color: #333;">–ó–∞–ª–∏—à–∏—Ç–∏ –≤—ñ–¥–≥—É–∫</h2>
            <p style="color: #666;">–û—Ü—ñ–Ω—ñ—Ç—å —Ä–æ–±–æ—Ç—É –º–∞–π—Å—Ç—Ä–∞</p>
            <form id="reviewForm" method="post">
                <div class="rating" style="margin: 20px 0;">
                    <input type="radio" id="star5" name="rating" value="5" required /><label for="star5">‚òÖ</label>
                    <input type="radio" id="star4" name="rating" value="4" /><label for="star4">‚òÖ</label>
                    <input type="radio" id="star3" name="rating" value="3" /><label for="star3">‚òÖ</label>
                    <input type="radio" id="star2" name="rating" value="2" /><label for="star2">‚òÖ</label>
                    <input type="radio" id="star1" name="rating" value="1" /><label for="star1">‚òÖ</label>
                </div>
                <div class="input-group">
                    <textarea name="comment" placeholder="–í–∞—à –∫–æ–º–µ–Ω—Ç–∞—Ä (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)" rows="4" style="width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ccc; background: white; color: black;"></textarea>
                </div>
                <button type="submit" class="btn-submit-pay" style="margin-top: 20px; width: 100%;">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –≤—ñ–¥–≥—É–∫</button>
            </form>
        </div>
    </div>

    <script>
        const modal = document.getElementById('paymentModal');
        const cardForm = document.getElementById('cardForm');
        const amountDisplay = document.getElementById('modalAmountDisplay');

        function openPaymentModal(bookingId, price) {
            amountDisplay.textContent = '–î–æ —Å–ø–ª–∞—Ç–∏: ' + price + ' –≥—Ä–Ω';
            cardForm.action = '/web/bookings/' + bookingId + '/pay';
            modal.style.display = 'flex';
        }

        function closePaymentModal() {
            modal.style.display = 'none';
        }

        const reviewModal = document.getElementById('reviewModal');
        const reviewForm = document.getElementById('reviewForm');

        function openReviewModal(bookingId) {
            reviewForm.action = '/web/bookings/' + bookingId + '/review';
            reviewModal.style.display = 'flex';
        }

        function closeReviewModal() {
            reviewModal.style.display = 'none';
        }

        window.onclick = function(event) {
            if (event.target == modal) {
                closePaymentModal();
            }
            if (event.target == reviewModal) {
                closeReviewModal();
            }
        }

        document.getElementById('card-number').addEventListener('input', function (e) {
            e.target.value = e.target.value.replace(/[^\d]/g, '').replace(/(.{4})/g, '$1 ').trim();
        });
    </script>
</body>
</html>
